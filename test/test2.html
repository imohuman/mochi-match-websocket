<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>websocket-chat</title>
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css"
    />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="https://mochi-match.work/socket.io/socket.io.js"></script>
  </head>
  <body>
    <div id="entry">
      名前：<input type="text" id="name" /> <button id="join">参加</button
      ><br />
    </div>
    <div id="in_room">
      <input type="text" id="chattext" />
      <button id="send">送信</button><br />
      <div id="inputlog"></div>
    </div>
    <script type="text/javascript">
      var socket = io.connect('wss://mochi-match.work/chatroom'); // C02. ソケットへの接続
      var inputmember = [];
      var chattimeout;

      document.getElementById('in_room').style.display = 'none';

      function timeout() {
        chattimeout = setTimeout(function () {
          socket.emit('stop_input', { room_id: 'test' });
        }, 3000);
      }
      function stoptimeout() {
        clearTimeout(chattimeout);
      }

      $('#join').click(function () {
        document.getElementById('in_room').style.display = 'block';
        document.getElementById('entry').style.display = 'none';
        socket.emit('join_req', {
          room_id: 'test',
          user: { user_name: document.getElementById('name').value },
        });
        return false;
      });
      $('#chattext').keyup(function () {
        socket.emit('start_input', { room_id: 'test' });
        stoptimeout();
        timeout();
      });
      $('#send').click(function () {
        socket.emit('stop_input', { room_id: 'test' });
        stoptimeout();
      });
      socket.on('notify_entry', function (data) {
        console.log(data);
      });
      socket.on('user_input_start', function (data) {
        console.log(data);
        if (!inputmember.includes(data.user_name)) {
          inputmember.push(data.user_name);
          rendering();
        }
      });
      socket.on('user_input_stop', function (data) {
        console.log(data);
        if (inputmember.includes(data.user_name)) {
          inputmember.splice(inputmember.indexOf(data.user_name), 1);
          rendering();
        }
      });
      function rendering() {
        console.log(inputmember);
        $('#inputlog').empty();
        for (m in inputmember) {
          $('#inputlog').append(
            '<div>' + inputmember[m] + 'さんが入力中' + '</div>'
          );
        }
      }
    </script>
  </body>
</html>
